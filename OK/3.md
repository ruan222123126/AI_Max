太棒了！看到你顺利完成 Step 2 并且成功打通了数据流（Ingestion -> Database），我们已经完成了最艰难的“脏活累活”。

现在，我们的数据库里有了持续跳动的“脉搏”（数据），Step 3 的目标就是构建**“神经系统” (API Layer)**。我们要把这些沉睡在数据库里的冷冰冰的数字，通过 API 变成前端应用可以理解和展示的实时信息。

以下是 Step 3 的完整执行流程：

### Step 3: 构建后端 API 服务 (API Development)

#### 目标

在 FastAPI 中开发两个核心接口，供未来的前端或 AI 代理调用：

1. **`/market/latest`**: 获取所有监控资产的最新价格（用于仪表盘概览）。
2. **`/market/history/{symbol}`**: 获取指定资产的历史走势（用于绘制 K 线图或趋势分析）。

---

#### 1. 升级后端代码 (`backend/main.py`)

我们需要彻底改造 `main.py`。不仅仅是启动服务，还要引入 **Pydantic 数据模型**来规范输出，并编写**异步 SQL 查询**来提取数据。

请将 `global-economy-platform/backend/main.py` 的内容**完全替换**为以下代码：

```python
from fastapi import FastAPI, HTTPException, Query
from pydantic import BaseModel
from typing import List
from datetime import datetime
from sqlalchemy.ext.asyncio import create_async_engine
from sqlalchemy import text
import os

app = FastAPI(title="Global Economy Platform API")

# 数据库配置
DATABASE_URL = os.getenv("DATABASE_URL")
engine = create_async_engine(DATABASE_URL, echo=True)

# --- Pydantic 模型 (定义数据契约) ---
class MarketTick(BaseModel):
    time: datetime
    symbol: str
    price: float

    class Config:
        from_attributes = True

# --- 启动事件 ---
@app.on_event("startup")
async def startup_event():
    # 确保表结构存在 (与 Step 1 逻辑保持一致)
    async with engine.begin() as conn:
        await conn.execute(text("""
            CREATE TABLE IF NOT EXISTS market_ticks (
                time TIMESTAMPTZ NOT NULL,
                symbol TEXT NOT NULL,
                price DOUBLE PRECISION
            );
        """))
        try:
            # 尝试转换为超表 (如果已存在会忽略警告)
            await conn.execute(text("SELECT create_hypertable('market_ticks', 'time', if_not_exists => TRUE);"))
        except Exception as e:
            print(f"TimescaleDB info: {e}")

# --- API 接口 ---

@app.get("/")
async def root():
    return {
        "status": "online", 
        "endpoints": ["/market/latest", "/market/history/{symbol}"]
    }

@app.get("/market/latest", response_model=List[MarketTick])
async def get_latest_prices():
    """
    获取每个资产的最新一条价格数据。
    使用 Postgres 的 DISTINCT ON 语法高效去重。
    """
    async with engine.connect() as conn:
        # DISTINCT ON (symbol) 保证每个 symbol 只取第一条
        # ORDER BY symbol, time DESC 保证取到的是时间最新的一条
        query = text("""
            SELECT DISTINCT ON (symbol) time, symbol, price
            FROM market_ticks
            ORDER BY symbol, time DESC;
        """)
        result = await conn.execute(query)
        # 将数据库行转换为字典列表
        return [
            {"time": row.time, "symbol": row.symbol, "price": row.price} 
            for row in result
        ]

@app.get("/market/history/{symbol}", response_model=List[MarketTick])
async def get_market_history(
    symbol: str, 
    limit: int = Query(100, le=1000) # 默认100条，最大允许1000条
):
    """
    获取指定资产的历史价格数据，用于绘图。
    """
    async with engine.connect() as conn:
        query = text("""
            SELECT time, symbol, price
            FROM market_ticks
            WHERE symbol = :symbol
            ORDER BY time DESC
            LIMIT :limit;
        """)
        result = await conn.execute(query, {"symbol": symbol, "limit": limit})
        rows = result.fetchall()
        
        if not rows:
            raise HTTPException(status_code=404, detail=f"Symbol '{symbol}' not found")
            
        return [
            {"time": row.time, "symbol": row.symbol, "price": row.price} 
            for row in rows
        ]

```

#### 2. 应用更改并重启

因为修改了 `main.py` 代码，FastAPI 的热重载（reload）功能通常会自动生效。但为了保险起见，建议重启后端容器以确保数据库连接池被正确重置。

**在项目根目录执行：**

```bash
docker-compose restart backend

```

#### 3. 验证 API (关键步骤)

现在，后端已经不仅仅是个空壳，它具备了数据分发能力。我们需要验证它是否能正确吐出你在 Step 2 中采集的数据。

**验证 1：获取最新行情 (Latest)**

在终端执行：

```bash
curl -s http://localhost:8000/market/latest

```

*预期输出*：你应该能看到一个 JSON 列表，包含 AAPL, BTC-USD 等资产的最新价格。

```json
[
  {"time":"2026-01-18T...","symbol":"AAPL","price":185.62},
  {"time":"2026-01-18T...","symbol":"BTC-USD","price":42317.44},
  ...
]

```

**验证 2：获取历史数据 (History)**

测试查询 `BTC-USD` 的历史记录：

```bash
curl -s "http://localhost:8000/market/history/BTC-USD?limit=5"

```

*预期输出*：BTC-USD 的最近 5 条价格记录。

**验证 3：浏览器可视化查看 (Swagger UI)**

这是 FastAPI 提供的杀手级功能。打开你的浏览器，访问：
👉 **http://localhost:8000/docs**

你应该能看到一个自动生成的交互式文档页面。

1. 点击 `/market/latest` -> `Try it out` -> `Execute`。
2. 查看 Server response，确认数据流是通的。

---

**任务清单：**

1. [ ] 将上面的代码完整覆盖写入 `backend/main.py`。
2. [ ] 执行 `docker-compose restart backend`。
3. [ ] 使用 `curl` 或浏览器访问 `http://localhost:8000/docs` 进行验证。
4. [ ] 截图或复制 API 返回的 JSON 数据作为完成凭证。

当你看到 API 返回了那串 JSON 数据，就意味着**后端开发 (Backend Dev)** 正式闭环了！数据已经准备好被“前端”或者“AI”消费了。

快去执行吧！