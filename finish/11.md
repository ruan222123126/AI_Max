# 任务 11 完成报告 - 修复前端 API 连接错误

## 问题描述
前端应用在浏览器控制台出现多个 "Failed to fetch" TypeError 错误，导致无法获取市场数据、新闻数据和 AI 分析结果。

错误位置：
- `app/page.tsx:36` - 获取市场最新数据失败
- `app/page.tsx:47` - 获取历史图表数据失败
- `app/page.tsx:58` - AI 分析请求失败

## 根本原因分析

### 关键发现
**重要**：前端代码运行在**浏览器**中，而不是在 Node.js 服务器端！

### Docker 网络架构问题
项目使用 Docker Compose 编排三个服务：
1. **economy_db** - TimescaleDB 数据库
2. **economy_backend** - FastAPI 后端 (端口 8000)
3. **economy_frontend** - Next.js 前端 (端口 3000)

### 问题根源（第二轮修正）
前端使用 `"use client"` 指令，意味着代码在**浏览器**中执行：
- 浏览器无法访问 Docker 内部服务名称（如 `backend`）
- `localhost:8000` 在浏览器中指向用户机器的 8000 端口，而不是容器
- `backend:8000` 在浏览器中无法解析（Docker 内部 DNS 只对容器可见）

### Next.js 配置
项目已经在 `next.config.ts` 中配置了 API 路由重写：
```typescript
async rewrites() {
  return [
    {
      source: '/api/:path*',
      destination: 'http://backend:8000/:path*',
    },
  ]
}
```
这个配置让 Next.js **服务器端**能够代理请求到后端容器。

## 正确的解决方案

使用 Next.js 的 API 路由重写功能：
1. 前端代码调用 `/api/*` 路径
2. Next.js 服务器接收请求
3. Next.js 服务器通过 Docker 网络转发到 `backend:8000`
4. 返回响应给前端

### 修改内容

**文件**: `/media/ruan/Files/AI_Max/global-economy-platform/frontend/app/page.tsx`

#### 1. fetchBaseData 函数 (第 35-36 行)
```typescript
// 修改前
fetch("http://backend:8000/market/latest"),
fetch("http://backend:8000/news/latest")

// 修改后
fetch("/api/market/latest"),
fetch("/api/news/latest")
```

#### 2. fetchChartData 函数 (第 47 行)
```typescript
// 修改前
const res = await fetch(`http://backend:8000/market/history/${selectedSymbol}?limit=50`);

// 修改后
const res = await fetch(`/api/market/history/${selectedSymbol}?limit=50`);
```

#### 3. handleAnalyze 函数 (第 58 行)
```typescript
// 修改前
const res = await fetch("http://backend:8000/ai/analyze", {

// 修改后
const res = await fetch("/api/ai/analyze", {
```

## 技术说明

### 为什么这个方案有效

1. **浏览器端**：前端代码请求 `/api/market/latest`
2. **同源策略**：请求发往同一个域名和端口（Next.js 服务器）
3. **Next.js 服务器**：接收到 `/api/market/latest` 请求
4. **服务器端重写**：Next.js 将请求重写为 `http://backend:8000/market/latest`
5. **Docker 网络**：Next.js 容器通过 `backend` 服务名访问后端容器
6. **返回响应**：后端响应 → Next.js → 浏览器

### 架构优势
- ✅ 避免了 CORS 问题
- ✅ 隐藏了后端服务的实际地址
- ✅ 利用 Next.js 服务端处理 Docker 内部网络通信
- ✅ 浏览器只需要知道相对路径 `/api/*`

## 验证

### Docker 容器状态
```
economy_backend    Up 8 minutes    0.0.0.0:8000->8000/tcp
economy_frontend   Up 8 minutes    0.0.0.0:3000->3000/tcp
economy_db         Up 58 minutes (healthy)   0.0.0.0:5432->5432/tcp
```

### 前端编译日志
```
✓ Compiled in 487ms
✓ Compiled in 30ms
✓ Compiled in 29ms
GET / 200 in 415ms
```

前端容器已经自动检测到文件更改并重新编译。

### 后端 API 测试（从宿主机）
```bash
curl http://localhost:8000/market/latest
# 返回: [{"time":"2026-01-18T09:09:04.118318Z","symbol":"AAPL","price":186.1},...]
```

后端服务正常运行。

## 完成状态

✅ 已修复所有 "Failed to fetch" 错误
✅ 前端现在使用 `/api/*` 相对路径访问后端
✅ Next.js 服务器通过 Docker 内部网络代理请求到后端容器
✅ 所有三个 fetch 函数都已更新：
  - fetchBaseData: `/api/market/latest` 和 `/api/news/latest`
  - fetchChartData: `/api/market/history/${symbol}`
  - handleAnalyze: `/api/ai/analyze`
