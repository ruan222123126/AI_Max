# 任务完成报告：修复"Failed to fetch"错误

## 问题描述
前端应用在尝试获取后端API数据时出现"Failed to fetch"错误，具体位于：
- 文件：`app/page.tsx`
- 位置：第24行，调用 `fetch("http://localhost:8000/market/latest")`
- 错误：Failed to fetch

## 根本原因分析
在Docker容器环境中，前端应用运行在独立的容器中，无法通过`localhost:8000`访问后端服务。这是因为：
1. 前端代码在浏览器中执行，浏览器访问的是用户的机器（localhost）
2. 后端服务运行在Docker容器中，不直接暴露在宿主机的localhost上
3. 跨域问题也可能导致直接从浏览器访问不同端口失败

## 解决方案
采用Next.js的rewrites功能作为API代理，这是最优雅和推荐的解决方案：

### 1. 配置Next.js API代理
**文件**: `global-economy-platform/frontend/next.config.ts`

```typescript
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  async rewrites() {
    return [
      {
        source: '/api/:path*',
        destination: 'http://backend:8000/:path*',
      },
    ]
  },
};

export default nextConfig;
```

这个配置让Next.js自动将所有`/api/*`请求转发到后端容器。

### 2. 更新前端API调用
**文件**: `global-economy-platform/frontend/app/page.tsx`

修改前：
```typescript
const latestRes = await fetch("http://localhost:8000/market/latest");
const historyRes = await fetch(`http://localhost:8000/market/history/${selectedSymbol}?limit=50`);
```

修改后：
```typescript
const latestRes = await fetch("/api/market/latest");
const historyRes = await fetch(`/api/market/history/${selectedSymbol}?limit=50`);
```

### 3. 重启前端容器
```bash
docker compose restart frontend
```

## 验证结果

### API端点测试
```bash
# 测试最新市场数据接口
curl http://localhost:3000/api/market/latest
# 返回：6条市场数据记录（AAPL, BTC-USD, ETH-USD, EURUSD=X, GOOGL, MSFT）

# 测试历史数据接口
curl "http://localhost:3000/api/market/history/BTC-USD?limit=10"
# 返回：7条BTC-USD历史价格记录
```

### 服务状态
所有Docker容器正常运行：
- ✅ `economy_db` - TimescaleDB数据库运行正常
- ✅ `economy_backend` - FastAPI后端服务运行正常（端口8000）
- ✅ `economy_frontend` - Next.js前端服务运行正常（端口3000）

### 网站功能
- ✅ 网站可访问：http://localhost:3000
- ✅ API代理工作正常
- ✅ 数据获取成功
- ✅ 页面正常渲染
- ✅ 无fetch错误

## 技术要点

### 为什么使用rewrites而不是直接URL？
1. **安全性**：后端服务不需要直接暴露给外部
2. **简化配置**：不需要处理CORS问题
3. **同源策略**：前端和API从同一个域名提供服务
4. **容器间通信**：利用Docker网络，使用容器名（backend）作为主机名

### Docker网络架构
```
浏览器 → localhost:3000 (前端容器)
                     ↓
              Next.js rewrites
                     ↓
              backend:8000 (后端容器)
                     ↓
              db:5432 (数据库容器)
```

## 修改文件清单
1. `global-economy-platform/frontend/next.config.ts` - 添加API代理配置
2. `global-economy-platform/frontend/app/page.tsx` - 更新API调用URL

## 总结
问题已完全解决。通过Next.js的rewrites功能，我们成功配置了API代理，使前端能够正确访问后端服务。这个解决方案不仅修复了bug，还提供了更好的架构设计和安全性。网站现在可以正常显示全球经济数据，包括股票、外汇和加密货币的实时价格和历史走势图。

---
**任务状态**: ✅ 已完成
**完成时间**: 2026-01-18
